<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rozkład jazdy PEKA Poznań</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Lato', sans-serif;
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #f5f5f5;
        }
        .header {
            background-color: #0066cc;
            color: white;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .search-container {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        #stop-search {
            padding: 0.5rem;
            border: none;
            border-radius: 4px;
            flex-grow: 1;
            font-size: 1rem;
        }
        #search-button {
            padding: 0.5rem 1rem;
            background-color: #FFD700;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
        }
        .time {
            background-color: black;
            color: #FFD700;
            padding: 0.5rem 1rem;
            font-family: 'Share Tech Mono', monospace;
            border-radius: 4px;
            align-self: flex-end;
        }
        .schedule {
            background-color: #f2f2f2;
            padding: 1rem;
            flex-grow: 1;
            overflow-y: auto;
        }
        .schedule-item {
            display: flex;
            align-items: center;
            padding: 0.8rem 0;
            border-bottom: 1px solid #ddd;
        }
        .line-number {
            font-weight: bold;
            min-width: 2rem;
            text-align: center;
            margin-right: 1rem;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
        }
        .line-1 { background-color: #e74c3c; }
        .line-2 { background-color: #3498db; }
        .line-3 { background-color: #2ecc71; }
        .line-4 { background-color: #9b59b6; }
        .line-5 { background-color: #f39c12; }
        .line-6 { background-color: #1abc9c; }
        .line-7 { background-color: #d35400; }
        .line-8 { background-color: #8e44ad; }
        .line-9 { background-color: #c0392b; }
        .line-10 { background-color: #27ae60; }
        .line-11 { background-color: #16a085; }
        .line-12 { background-color: #7f8c8d; }
        .line-13 { background-color: #e67e22; }
        .line-14 { background-color: #2980b9; }
        .line-15 { background-color: #34495e; }
        .line-16 { background-color: #95a5a6; }
        .line-17 { background-color: #e74c3c; }
        .line-18 { background-color: #3498db; }
        .destination { flex-grow: 1; margin-right: 1rem; }
        .departure-time {
            font-weight: bold;
            min-width: 3.5rem;
            text-align: right;
        }
        .delayed {
            color: #e74c3c;
            font-weight: bold;
        }
        .loading, .error {
            text-align: center;
            padding: 1rem;
        }
        .error { color: #e74c3c; }
        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background-color: white;
        }
        .autocomplete-items div {
            padding: 0.5rem;
            cursor: pointer;
        }
        .autocomplete-items div:hover {
            background-color: #e9e9e9;
        }
        .autocomplete-active {
            background-color: #0066cc !important;
            color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="search-container">
            <input type="text" id="stop-search" placeholder="Wyszukaj przystanek (np. Jasna Rola)" autocomplete="off">
            <button id="search-button">Szukaj</button>
        </div>
        <div class="time" id="current-time">--:--</div>
    </div>
    <div class="schedule" id="schedule">
        <div class="loading">Wpisz nazwę przystanku.</div>
    </div>

    <script>
        // Lista przystanków (ID PEKA + nazwa)
        const stops = [
            { name: "Jasna Rola", stopId: "1054" },
            { name: "Rondo Żegierskie", stopId: "1001" },
            { name: "Dworzec Zachodni", stopId: "1002" },
            { name: "Plac Wolności", stopId: "1003" },
            { name: "Os. Sobieskiego", stopId: "1004" },
            { name: "Franowo", stopId: "1005" },
            { name: "Głogowska", stopId: "1006" },
            { name: "Rondo Kaponiera", stopId: "1007" }
        ];

        // Pobierz rozkład z PEKA API
        async function fetchDeparturesFromPEKA(stopId) {
            const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
            const targetUrl = `https://www.peka.poznan.pl/vm/mobile/departures.json?stop=${stopId}`;

            try {
                const response = await fetch(proxyUrl + targetUrl);
                const data = await response.json();
                return data.departures || [];
            } catch (error) {
                console.error("Błąd pobierania danych z PEKA:", error);
                return null;
            }
        }

        // Autouzupełnianie wyszukiwarki
        function setupAutocomplete() {
            const input = document.getElementById('stop-search');
            input.addEventListener('input', function() {
                const val = this.value.toLowerCase();
                closeAllLists();
                if (!val) return false;

                const matches = stops.filter(stop =>
                    stop.name.toLowerCase().includes(val)
                );

                if (matches.length === 0) return false;

                const list = document.createElement('div');
                list.setAttribute('id', 'autocomplete-list');
                list.setAttribute('class', 'autocomplete-items');
                this.parentNode.appendChild(list);

                matches.forEach(stop => {
                    const item = document.createElement('div');
                    item.innerHTML = `<strong>${stop.name}</strong>`;
                    item.addEventListener('click', () => {
                        input.value = stop.name;
                        loadScheduleForStop(stop.stopId, stop.name);
                        closeAllLists();
                    });
                    list.appendChild(item);
                });
            });

            // Obsługa klawiatury
            input.addEventListener('keydown', function(e) {
                const list = document.getElementById('autocomplete-list');
                if (list) {
                    const items = list.getElementsByTagName('div');
                    if (e.keyCode === 40) { // STRZAŁKA W DÓŁ
                        let current = list.getElementsByClassName('autocomplete-active')[0];
                        if (current) current.classList.remove('autocomplete-active');
                        if (current && current.nextSibling) {
                            current.nextSibling.classList.add('autocomplete-active');
                        } else if (items.length > 0) {
                            items[0].classList.add('autocomplete-active');
                        }
                    } else if (e.keyCode === 38) { // STRZAŁKA W GÓRĘ
                        let current = list.getElementsByClassName('autocomplete-active')[0];
                        if (current) current.classList.remove('autocomplete-active');
                        if (current && current.previousSibling) {
                            current.previousSibling.classList.add('autocomplete-active');
                        }
                    } else if (e.keyCode === 13) { // ENTER
                        e.preventDefault();
                        if (list.getElementsByClassName('autocomplete-active')[0]) {
                            list.getElementsByClassName('autocomplete-active')[0].click();
                        }
                    }
                }
            });

            document.addEventListener('click', function(e) {
                if (e.target.id !== 'stop-search') closeAllLists();
            });
        }

        function closeAllLists() {
            const lists = document.getElementsByClassName('autocomplete-items');
            for (let i = 0; i < lists.length; i++) {
                lists[i].parentNode.removeChild(lists[i]);
            }
        }

        // Pobierz i wyświetl rozkład
        async function loadScheduleForStop(stopId, stopName) {
            document.getElementById('schedule').innerHTML = `
                <div class="loading">Ładowanie rozkładu dla ${stopName}...</div>
            `;

            const departures = await fetchDeparturesFromPEKA(stopId);
            if (!departures) {
                document.getElementById('schedule').innerHTML = `
                    <div class="error">Nie udało się pobrać danych dla ${stopName}.</div>
                `;
                return;
            }

            renderTrams(departures, stopName);
        }

        // Wyświetl rozkład
        function renderTrams(departures, stopName) {
            const now = new Date();
            const scheduleElement = document.getElementById('schedule');

            if (departures.length === 0) {
                scheduleElement.innerHTML = `
                    <div class="loading">Brak odjazdów dla ${stopName}.</div>
                `;
                return;
            }

            // Przetwórz dane: oblicz minuty do odjazdu
            const trams = departures
                .map(dep => {
                    const depTime = new Date(dep.time);
                    const diffMinutes = Math.floor((depTime - now) / 60000);
                    return {
                        line: dep.route.shortName,
                        destination: dep.route.direction,
                        time: Math.max(0, diffMinutes),
                        delayed: dep.delay > 0
                    };
                })
                .filter(dep => dep.time >= 0)
                .sort((a, b) => a.time - b.time)
                .slice(0, 10);

            scheduleElement.innerHTML = `
                <div class="schedule-item" style="font-weight: bold; background-color: #e9e9e9;">
                    <div style="flex-grow: 1;">Przystanek: ${stopName}</div>
                </div>
                ${trams.map(tram => `
                    <div class="schedule-item">
                        <div class="line-number line-${tram.line}">${tram.line}</div>
                        <div class="destination-time-container" style="display: flex; justify-content: space-between; flex-grow: 1;">
                            <span class="destination">${tram.destination}</span>
                            <span class="departure-time ${tram.delayed ? 'delayed' : ''}">
                                ${tram.time} min ${tram.delayed ? '(opóźnienie)' : ''}
                            </span>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        // Obsługa przycisku "Szukaj"
        document.getElementById('search-button').addEventListener('click', () => {
            const input = document.getElementById('stop-search');
            const stopName = input.value;
            if (!stopName) return;

            const stop = stops.find(s => s.name.toLowerCase() === stopName.toLowerCase());
            if (stop) {
                loadScheduleForStop(stop.stopId, stop.name);
            } else {
                document.getElementById('schedule').innerHTML = `
                    <div class="error">Nie znaleziono przystanku "${stopName}".</div>
                `;
            }
        });

        // Aktualizuje zegar
        function updateClock() {
            const now = new Date();
            document.getElementById('current-time').textContent =
                `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
        }

        // Odświeża co 30 sekund
        setInterval(() => {
            updateClock();
        }, 30000);

        // Inicjalizacja
        setupAutocomplete();
        updateClock();
    </script>
</body>
</html>
